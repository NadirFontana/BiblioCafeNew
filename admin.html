<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiblioCaf√® - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <div id="notification" class="notification"></div>

    <div id="loginForm">
        <h2 style="margin-bottom: 1.5rem;">Admin Login</h2>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%">Login</button>
        </form>
    </div>

    <div id="adminPanel" class="hidden">
        <header class="admin-header">
            <h1>BiblioCaf√® Admin Panel</h1>
            <button onclick="handleLogout()" class="btn btn-danger">Logout</button>
        </header>

        <div class="categories-mobile">
            <div class="categories-scroll" id="categoryListMobile">
                <!-- Le categorie verranno inserite qui via JavaScript -->
            </div>
        </div>

        <div class="admin-container">
            <div class="admin-grid">
                <aside class="sidebar">
                    <h3 style="margin-bottom: 1rem;">Categorie</h3>
                    <div id="categoryList"></div>
                </aside>

                <main class="main-content">
                    <div id="productTable"></div>
                    
                    <div id="menuManagementPanel" class="hidden" style="padding: 2rem; background: var(--paper-color); border-radius: 12px; box-shadow: 0 2px 15px var(--shadow);">
                        <!-- This will be populated dynamically by JavaScript -->
                    </div>

                    <div id="qrCodePanel" class="hidden" style="padding: 2rem; background: var(--paper-color); border-radius: 12px; box-shadow: 0 2px 15px var(--shadow); text-align: center;">
                        <h3 style="margin-bottom: 2rem; color: var(--primary-color);">QR Code Menu</h3>
                        <div style="margin-bottom: 2rem;">
                            <p style="color: var(--text-color); margin-bottom: 1rem;">Scansiona questo QR Code per accedere al menu digitale:</p>
                            <div id="qrCodeContainer" style="display: flex; justify-content: center; margin: 2rem 0;">
                                <!-- QR Code will be generated here -->
                            </div>
                            <p style="color: var(--accent-color); font-size: 0.9rem; margin-top: 1rem;">
                                <strong>URL:</strong> <span id="menuUrl"></span>
                            </p>
                        </div>
<div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
    <button onclick="printQRCode()" class="btn btn-primary">üñ®Ô∏è Stampa QR Code</button>
    <button onclick="hideQRCodePanel()" class="btn btn-danger">‚¨ÖÔ∏è Indietro</button>
</div>
                    </div>
                    
                    <div id="productForm" class="hidden">
                        <h3 style="margin-bottom: 1.5rem;">Aggiungi/Modifica Prodotto</h3>
                        <form onsubmit="handleProductSubmit(event)">
                            <input type="hidden" id="productId">
                            <div class="form-group">
                                <label for="category">Categoria</label>
                                <select id="category" class="form-control" required></select>
                            </div>
                            <div class="form-group">
                                <label for="name">Nome</label>
                                <input type="text" id="name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="description">Descrizione</label>
                                <textarea id="description" class="form-control" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="price">Prezzo (‚Ç¨)</label>
                                <input type="number" id="price" class="form-control" step="0.10" min="0" required>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button type="submit" class="btn btn-primary">Salva</button>
                                <button type="button" onclick="hideProductForm()" class="btn btn-danger">Annulla</button>
                            </div>
                        </form>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Carica il database manager -->
    <script src="db.js"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>

    <script>
// ==========================================
// DATABASE MANAGER E CREDENZIALI
// ==========================================

// Credenziali admin
const ADMIN_CREDENTIALS = {
    username: 'caffetteria',
    password: 'menu2024'
};

// Variabili globali
let currentCategories = [];
let currentProducts = [];
let currentCategoryFilter = null;
let qrCodeInstance = null;

// ==========================================
// FUNZIONI UTILITARIE
// ==========================================

function showNotification(message, duration = 3000) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, duration);
}

function getCategoryData(categoryId) {
    return currentCategories.find(c => c.id === categoryId);
}

// ==========================================
// GESTIONE LOGIN/LOGOUT
// ==========================================

function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        showNotification('Login effettuato con successo');
        
        // Inizializza l'interfaccia admin
        initializeAdminPanel();
    } else {
        showNotification('Credenziali non valide');
    }
}

function handleLogout() {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    showNotification('Logout effettuato con successo');
}

// ==========================================
// INIZIALIZZAZIONE ADMIN PANEL
// ==========================================

async function initializeAdminPanel() {
    try {
        // Inizializza il database
        await menuDB.init();
        await menuDB.seedDatabase();
        
        // Carica dati dal database
        await loadDataFromDatabase();
        
        // Popola l'interfaccia
        loadCategories();
        loadProducts();
        
        console.log('Admin panel inizializzato con successo');
        console.log(`Categorie: ${currentCategories.length}, Prodotti: ${currentProducts.length}`);
        
    } catch (error) {
        console.error('Errore inizializzazione admin panel:', error);
        showNotification('Errore nel caricamento dei dati dal database');
    }
}

async function loadDataFromDatabase() {
    try {
        currentCategories = await menuDB.getAllCategories();
        currentProducts = await menuDB.getAllProducts();
    } catch (error) {
        console.error('Errore nel caricamento dati:', error);
        throw error;
    }
}

function loadCategories() {
    // Popola la sidebar delle categorie (desktop)
    const categoryList = document.getElementById('categoryList');
    categoryList.innerHTML = currentCategories.map(category => `
        <button 
            onclick="filterProducts('${category.id}')" 
            class="btn btn-primary" 
            style="width: 100%; margin-bottom: 0.5rem;">
            ${category.emoji} ${category.name}
        </button>
    `).join('') + `
        <button 
            onclick="showAllProducts()" 
            class="btn btn-primary" 
            style="width: 100%; margin-bottom: 0.5rem;">
            üìã Tutti i Prodotti
        </button>
        <button 
            onclick="showAddProductForm()" 
            class="btn btn-primary" 
            style="width: 100%; margin-bottom: 0.5rem;">
            ‚ûï Aggiungi Prodotto
        </button>
        <button 
            onclick="showQRCodePanel()" 
            class="btn btn-primary" 
            style="width: 100%; margin-bottom: 0.5rem;">
            üì± QR Code
        </button>
    `;

    // Popola la barra categorie mobile
    const categoryListMobile = document.getElementById('categoryListMobile');
    categoryListMobile.innerHTML = currentCategories.map(category => `
        <button 
            onclick="filterProducts('${category.id}')" 
            class="nav-button">
            ${category.emoji} ${category.name}
        </button>
    `).join('') + `
        <button 
            onclick="showAllProducts()" 
            class="nav-button">
            üìã Tutti
        </button>
        <button 
            onclick="showAddProductForm()" 
            class="nav-button">
            ‚ûï Aggiungi
        </button>
        <button 
            onclick="showQRCodePanel()" 
            class="nav-button">
            üì± QR Code
        </button>
    `;

    // Popola il select delle categorie nel form
    const categorySelect = document.getElementById('category');
    categorySelect.innerHTML = currentCategories.map(category => `
        <option value="${category.id}">${category.emoji} ${category.name}</option>
    `).join('');
}

// ==========================================
// GESTIONE PRODOTTI
// ==========================================

function loadProducts(categoryFilter = null) {
    currentCategoryFilter = categoryFilter;
    
    let filteredProducts = categoryFilter 
        ? currentProducts.filter(p => p.category === categoryFilter)
        : currentProducts;

    const productTable = document.getElementById('productTable');
    
    if (filteredProducts.length === 0) {
        productTable.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #666;">
                <h3>Nessun prodotto trovato</h3>
                <p>Non ci sono prodotti ${categoryFilter ? 'in questa categoria' : 'nel database'}</p>
                <button onclick="showAddProductForm()" class="btn btn-primary">Aggiungi Prodotto</button>
            </div>
        `;
        return;
    }

    productTable.innerHTML = `
        <div class="products-grid">
            ${filteredProducts.map(product => {
                const categoryData = getCategoryData(product.category);
                return `
                    <div class="product-card">
                        <div class="product-header">
                            <h3 class="product-title">${product.name}</h3>
                            <span class="product-category">
                                ${categoryData?.emoji || ''} ${categoryData?.name || product.category}
                            </span>
                        </div>
                        <p class="product-description">${product.description}</p>
                        <div class="product-footer">
                            <span class="product-price">‚Ç¨${product.price.toFixed(2)}</span>
                            <div class="product-actions">
                                <button onclick="editProduct(${product.id})" class="btn btn-primary">Modifica</button>
                                <button onclick="deleteProduct(${product.id})" class="btn btn-danger">Elimina</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function filterProducts(category) {
    loadProducts(category);
}

function showAllProducts() {
    loadProducts();
}

async function editProduct(id) {
    try {
        const product = await menuDB.getProduct(id);
        if (product) {
            hideAllPanels();
            document.getElementById('productForm').classList.remove('hidden');
            
            document.getElementById('productId').value = product.id;
            document.getElementById('category').value = product.category;
            document.getElementById('name').value = product.name;
            document.getElementById('description').value = product.description;
            document.getElementById('price').value = product.price;
        }
    } catch (error) {
        console.error('Errore nel caricamento prodotto:', error);
        showNotification('Errore nel caricamento del prodotto');
    }
}

async function deleteProduct(id) {
    if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
        try {
            await menuDB.deleteProduct(id);
            await loadDataFromDatabase(); // Ricarica i dati
            loadProducts(currentCategoryFilter); // Mantieni il filtro attuale
            showNotification('Prodotto eliminato con successo');
        } catch (error) {
            console.error('Errore eliminazione prodotto:', error);
            showNotification('Errore nell\'eliminazione del prodotto');
        }
    }
}

// ==========================================
// GESTIONE PANNELLI
// ==========================================

function hideAllPanels() {
    document.getElementById('productTable').classList.add('hidden');
    document.getElementById('menuManagementPanel').classList.add('hidden');
    document.getElementById('qrCodePanel').classList.add('hidden');
    document.getElementById('productForm').classList.add('hidden');
}

function showProductTable() {
    hideAllPanels();
    document.getElementById('productTable').classList.remove('hidden');
}

// ==========================================
// GESTIONE QR CODE
// ==========================================

function showQRCodePanel() {
    hideAllPanels();
    document.getElementById('qrCodePanel').classList.remove('hidden');
    generateQRCode();
}

function hideQRCodePanel() {
    hideAllPanels();
    document.getElementById('productTable').classList.remove('hidden');
}

async function generateQRCode() {
    try {
        // Mostra un messaggio personalizzato invece dell'URL completo
        document.getElementById('menuUrl').textContent = 'Menu Digitale BiblioCaf√®';
        
        // Pulisce il container del QR code
        const qrContainer = document.getElementById('qrCodeContainer');
        qrContainer.innerHTML = '';
        
        // Crea un elemento immagine invece di generare il QR code
        const img = document.createElement('img');
        img.src = './img/QRMenu.png'; // Percorso relativo all'immagine
        img.alt = 'QR Code Menu BiblioCaf√®';
        img.style.width = '300px';
        img.style.height = '300px';
        img.style.border = '2px solid var(--primary-color)';
        img.style.borderRadius = '12px';
        img.style.boxShadow = '0 4px 12px var(--shadow)';
        
        // Gestisci eventuali errori di caricamento dell'immagine
        img.onerror = function() {
            console.error('Errore nel caricamento dell\'immagine QR Code');
            qrContainer.innerHTML = `
                <div style="
                    width: 300px; 
                    height: 300px; 
                    border: 2px dashed var(--primary-color); 
                    border-radius: 12px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    color: var(--text-color);
                    text-align: center;
                    font-size: 0.9rem;
                ">
                    <div>
                        üì±<br>
                        Immagine QR Code<br>
                        non trovata
                    </div>
                </div>
            `;
            showNotification('Immagine QR Code non trovata');
        };
        
        img.onload = function() {
            console.log('QR Code caricato con successo');
        };
        
        qrContainer.appendChild(img);
        
        // Salva il riferimento per le funzioni di download e stampa
        qrCodeInstance = img;
        
    } catch (error) {
        console.error('Errore nel caricamento del QR Code:', error);
        showNotification('Errore nel caricamento del QR Code');
    }
}

function downloadQRCode() {
    if (!qrCodeInstance) {
        showNotification('QR Code non disponibile per il download');
        return;
    }
    
    try {
        // Se √® un'immagine, usa il percorso diretto
        if (qrCodeInstance.tagName === 'IMG') {
            const link = document.createElement('a');
            link.download = 'bibliocafe-menu-qr.png';
            link.href = qrCodeInstance.src;
            link.click();
            
            showNotification('QR Code scaricato con successo');
        } 
        // Se √® un canvas (per compatibilit√† con codice precedente)
        else if (qrCodeInstance.tagName === 'CANVAS') {
            const link = document.createElement('a');
            link.download = 'bibliocafe-menu-qr.png';
            link.href = qrCodeInstance.toDataURL('image/png');
            link.click();
            
            showNotification('QR Code scaricato con successo');
        }
        else {
            showNotification('Formato QR Code non supportato per il download');
        }
        
    } catch (error) {
        console.error('Errore nel download del QR Code:', error);
        showNotification('Errore nel download del QR Code');
    }
}

function printQRCode() {
    if (!qrCodeInstance) {
        showNotification('QR Code non disponibile per la stampa');
        return;
    }
    
    try {
        // Usa un messaggio personalizzato invece dell'URL del file system
        const menuUrl = 'Menu Digitale BiblioCaf√®';
        
        // Ottieni l'URL dell'immagine per la stampa
        let imageUrl;
        if (qrCodeInstance.tagName === 'IMG') {
            imageUrl = qrCodeInstance.src;
        } else if (qrCodeInstance.tagName === 'CANVAS') {
            imageUrl = qrCodeInstance.toDataURL('image/png');
        } else {
            showNotification('Formato QR Code non supportato per la stampa');
            return;
        }
        
        // Crea una finestra per la stampa
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>QR Code Menu - BiblioCaf√®</title>
                <style>
                    body {
                        font-family: 'Poppins', Arial, sans-serif;
                        text-align: center;
                        padding: 2rem;
                        background: white;
                    }
                    .qr-container {
                        border: 2px solid #0c4840;
                        border-radius: 12px;
                        padding: 2rem;
                        margin: 2rem auto;
                        max-width: 400px;
                        background: #f0f5f3;
                    }
                    h1 {
                        color: #0c4840;
                        margin-bottom: 1rem;
                    }
                    .qr-image {
                        max-width: 100%; 
                        height: auto;
                        border-radius: 8px;
                    }
                    .url {
                        font-size: 0.9rem;
                        color: #15705f;
                        margin-top: 1rem;
                        word-break: break-all;
                    }
                    .instructions {
                        margin-top: 1.5rem;
                        color: #666;
                        font-size: 0.9rem;
                    }
                    @media print {
                        body { margin: 0; padding: 1rem; }
                        .qr-container { border: 2px solid #000; }
                    }
                </style>
            </head>
            <body>
                <div class="qr-container">
                    <h1>BiblioCaf√®</h1>
                    <h2>Menu Digitale</h2>
                    <img src="${imageUrl}" alt="QR Code Menu" class="qr-image">
                    <div class="url">${menuUrl}</div>
                    <div class="instructions">
                        Inquadra il QR Code con la fotocamera del tuo smartphone<br>
                        per accedere al menu digitale
                    </div>
                </div>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Stampa dopo che l'immagine √® caricata
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
        
        showNotification('QR Code inviato alla stampante');
        
    } catch (error) {
        console.error('Errore nella stampa del QR Code:', error);
        showNotification('Errore nella stampa del QR Code');
    }
}

// ==========================================
// GESTIONE FORM PRODOTTI
// ==========================================

function showMenuManagementPanel() {
    hideAllPanels();
    const menuManagementPanel = document.getElementById('menuManagementPanel');
    menuManagementPanel.classList.remove('hidden');
    
    menuManagementPanel.innerHTML = `
        <div class="menu-management-options" style="display: flex; flex-direction: column; gap: 1rem;">
            <h3 style="margin-bottom: 1rem;">Gestione Menu</h3>
            <button onclick="showAddProductForm()" class="btn btn-primary" style="width: 100%;">
                ‚ûï Aggiungi Prodotto
            </button>
            <button onclick="exportMenuData()" class="btn btn-primary" style="width: 100%;">
                üì• Esporta Menu
            </button>
            <button onclick="resetDatabase()" class="btn btn-warning" style="width: 100%;">
                üîÑ Reset Database
            </button>
            <button onclick="cancelMenuManagement()" class="btn btn-danger" style="width: 100%;">
                ‚¨ÖÔ∏è Indietro
            </button>
        </div>
    `;
}

function cancelMenuManagement() {
    showProductTable();
}

function showAddProductForm() {
    hideAllPanels();
    document.getElementById('productForm').classList.remove('hidden');
    
    // Reset form
    document.getElementById('productId').value = '';
    document.getElementById('category').value = currentCategories.length > 0 ? currentCategories[0].id : '';
    document.getElementById('name').value = '';
    document.getElementById('description').value = '';
    document.getElementById('price').value = '';
}

function hideProductForm() {
    hideAllPanels();
    document.getElementById('productTable').classList.remove('hidden');
}

async function handleProductSubmit(event) {
    event.preventDefault();
    
    try {
        const productId = document.getElementById('productId').value;
        const newProduct = {
            id: productId ? parseInt(productId) : await menuDB.getNextProductId(),
            category: document.getElementById('category').value,
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            price: parseFloat(document.getElementById('price').value)
        };

        await menuDB.addProduct(newProduct); // addProduct funziona sia per inserimento che aggiornamento
        await loadDataFromDatabase(); // Ricarica i dati
        
        hideProductForm();
        loadProducts(currentCategoryFilter); // Mantieni il filtro attuale
        
        if (productId) {
            showNotification('Prodotto modificato con successo');
        } else {
            showNotification('Prodotto aggiunto con successo');
        }
        
    } catch (error) {
        console.error('Errore salvataggio prodotto:', error);
        showNotification('Errore nel salvataggio del prodotto');
    }
}

// ==========================================
// FUNZIONI UTILIT√Ä AGGIUNTIVE
// ==========================================

function exportMenuData() {
    try {
        const menuData = {
            categories: currentCategories,
            products: currentProducts,
            exportDate: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(menuData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `bibliocafe-menu-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showNotification('Menu esportato con successo');
    } catch (error) {
        console.error('Errore esportazione:', error);
        showNotification('Errore nell\'esportazione del menu');
    }
}

async function resetDatabase() {
    if (confirm('ATTENZIONE: Questa operazione canceller√† tutti i dati e ripristiner√† il menu originale. Continuare?')) {
        try {
            await menuDB.clearDatabase();
            await menuDB.seedDatabase();
            await loadDataFromDatabase();
            
            loadCategories();
            loadProducts();
            
            showNotification('Database ripristinato con successo');
        } catch (error) {
            console.error('Errore reset database:', error);
            showNotification('Errore nel ripristino del database');
        }
    }
}

// ==========================================
// INIZIALIZZAZIONE AL CARICAMENTO PAGINA
// ==========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('BiblioCaf√® Admin Panel caricato con database IndexedDB');
});
    </script>


</body>
</html>