<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiblioCaf√® - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
</head>

<body>
    <!-- Notification System -->
    <div id="notification" class="notification"></div>

    <!-- Login Form -->
    <div id="loginForm">
        <h2>Admin Login</h2>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden">
        <!-- Header -->
        <header class="admin-header">
            <h1>BiblioCaf√® Admin Panel</h1>
            <button onclick="logout()" class="btn btn-danger">Logout</button>
        </header>

        <!-- Mobile Navigation -->
        <nav class="categories-mobile">
            <div class="categories-scroll" id="categoryListMobile"></div>
        </nav>

        <!-- Main Container -->
        <div class="admin-container">
            <div class="admin-grid">
                <!-- Desktop Sidebar -->
                <aside class="sidebar">
                    <h3>Categorie</h3>
                    <div id="categoryList"></div>
                </aside>

                <!-- Main Content Area -->
                <main class="main-content">
                    <!-- Products Table -->
                    <section id="productTable"></section>

                    <!-- QR Code Panel -->
                    <section id="qrCodePanel" class="panel hidden">
                        <h3>QR Code Menu</h3>
                        <div id="qrCodeContainer" class="qr-container"></div>
                        <p class="qr-info">
                            <strong>URL:</strong> Menu Digitale BiblioCaf√®
                        </p>
                        <div class="panel-actions">
                            <button onclick="printQRCode()" class="btn btn-primary">üñ®Ô∏è Stampa QR Code</button>
                            <button onclick="showProducts()" class="btn btn-danger">‚¨ÖÔ∏è Indietro</button>
                        </div>
                    </section>

                    <!-- Category Management Panel -->
                    <section id="categoryManagement" class="panel hidden">
                        <h3>Gestione Categorie</h3>
                        <div class="management-actions">
                            <button onclick="showCategoryForm('add')" class="btn btn-primary">‚ûï Aggiungi Categoria</button>
                            <button onclick="showCategoryForm('edit')" class="btn btn-primary">‚úèÔ∏è Modifica Categoria</button>
                            <button onclick="showCategoryForm('delete')" class="btn btn-primary">üóëÔ∏è Elimina Categoria</button>
                            <button onclick="showProducts()" class="btn btn-danger">‚¨ÖÔ∏è Indietro</button>
                        </div>
                    </section>

                    <!-- Product Form -->
                    <section id="productForm" class="panel hidden">
                        <h3>Aggiungi/Modifica Prodotto</h3>
                        <form onsubmit="saveProduct(event)">
                            <input type="hidden" id="productId">
                            
                            <div class="form-group">
                                <label for="category">Categoria</label>
                                <select id="category" class="form-control" required></select>
                            </div>
                            
                            <div class="form-group">
                                <label for="name">Nome</label>
                                <input type="text" id="name" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="description">Descrizione</label>
                                <textarea id="description" class="form-control" rows="3" required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="price">Prezzo (‚Ç¨)</label>
                                <input type="number" id="price" class="form-control" step="0.10" min="0" required>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Salva</button>
                                <button type="button" onclick="showProducts()" class="btn btn-danger">Annulla</button>
                            </div>
                        </form>
                    </section>

                    <!-- Category Form -->
                    <section id="categoryForm" class="panel hidden">
                        <h3 id="categoryFormTitle">Gestione Categoria</h3>
                        <form onsubmit="saveCategory(event)">
                            <input type="hidden" id="categoryMode">
                            <input type="hidden" id="originalCategoryId">

                            <div class="form-group" id="categorySelect">
                                <label for="categoryToEdit">Seleziona Categoria</label>
                                <select id="categoryToEdit" class="form-control" onchange="loadCategoryData()"></select>
                            </div>

                            <div class="form-group">
                                <label for="categoryId">ID Categoria</label>
                                <input type="text" id="categoryId" class="form-control" required 
                                       pattern="[a-z0-9-]+" title="Solo lettere minuscole, numeri e trattini">
                            </div>

                            <div class="form-group">
                                <label for="categoryName">Nome Categoria</label>
                                <input type="text" id="categoryName" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label for="categoryEmoji">Emoji</label>
                                <input type="text" id="categoryEmoji" class="form-control" maxlength="2" required>
                            </div>

                            <div class="form-actions">
                                <button type="submit" id="categorySubmitBtn" class="btn btn-primary">Salva</button>
                                <button type="button" onclick="showCategoryManagement()" class="btn btn-danger">Annulla</button>
                            </div>
                        </form>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <!-- External Scripts -->
    <script src="db.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        const CONFIG = {
            ADMIN_CREDENTIALS: {
                username: 'caffetteria',
                password: 'menu2024'
            },
            NOTIFICATION_DURATION: 3000
        };

        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        
        class AppState {
            constructor() {
                this.categories = [];
                this.products = [];
                this.currentFilter = null;
                this.isLoggedIn = false;
            }

            async loadData() {
                this.categories = await menuDB.getAllCategories();
                this.products = await menuDB.getAllProducts();
            }

            getCategoryName(categoryId) {
                const category = this.categories.find(c => c.id === categoryId);
                return category ? `${category.emoji} ${category.name}` : categoryId;
            }
        }

        const appState = new AppState();

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        const Utils = {
            showNotification(message, duration = CONFIG.NOTIFICATION_DURATION) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', duration);
            },

            hideAllPanels() {
                const panels = ['productTable', 'qrCodePanel', 'categoryManagement', 'productForm', 'categoryForm'];
                panels.forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            },

            resetForm(formSelector) {
                document.querySelector(formSelector).reset();
            },

            validateForm(formData) {
                return Object.values(formData).every(value => 
                    value !== null && value !== undefined && value !== ''
                );
            }
        };

        // ==========================================
        // AUTHENTICATION MODULE
        // ==========================================
        
        const Auth = {
            handleLogin(event) {
                event.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (this.validateCredentials(username, password)) {
                    this.showAdminPanel();
                    App.initialize();
                    Utils.showNotification('Login effettuato con successo');
                } else {
                    Utils.showNotification('Credenziali non valide');
                }
            },

            validateCredentials(username, password) {
                return username === CONFIG.ADMIN_CREDENTIALS.username && 
                       password === CONFIG.ADMIN_CREDENTIALS.password;
            },

            showAdminPanel() {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                appState.isLoggedIn = true;
            },

            logout() {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                appState.isLoggedIn = false;
                Utils.showNotification('Logout effettuato');
            }
        };

        // ==========================================
        // UI RENDERING MODULE
        // ==========================================
        
        const UI = {
            renderCategories() {
                const buttons = [
                    ...appState.categories.map(cat => 
                        `<button onclick="ProductManager.filterProducts('${cat.id}')" class="btn btn-primary">
                            ${cat.emoji} ${cat.name}
                        </button>`
                    ),
                    '<button onclick="ProductManager.showProducts()" class="btn btn-primary">üìã Tutti i Prodotti</button>',
                    '<button onclick="ProductManager.showProductForm()" class="btn btn-primary">‚ûï Aggiungi Prodotto</button>',
                    '<button onclick="CategoryManager.showCategoryManagement()" class="btn btn-primary">üìÇ Gestisci Categorie</button>',
                    '<button onclick="QRCodeManager.showQRCode()" class="btn btn-primary">üì± QR Code</button>'
                ];

                // Desktop sidebar
                document.getElementById('categoryList').innerHTML = 
                    buttons.map(btn => btn.replace('class="btn btn-primary"', 'class="btn btn-primary sidebar-btn')).join('');

                // Mobile navigation
                document.getElementById('categoryListMobile').innerHTML = 
                    buttons.map(btn => btn.replace('class="btn btn-primary"', 'class="nav-button"')).join('');

                // Form select options
                document.getElementById('category').innerHTML = 
                    appState.categories.map(cat => `<option value="${cat.id}">${cat.emoji} ${cat.name}</option>`).join('');
            },

            renderProducts() {
                const filteredProducts = appState.currentFilter 
                    ? appState.products.filter(p => p.category === appState.currentFilter)
                    : appState.products;

                const container = document.getElementById('productTable');

                if (filteredProducts.length === 0) {
                    container.innerHTML = this.renderEmptyState();
                    return;
                }

                container.innerHTML = `
                    <div class="products-grid">
                        ${filteredProducts.map(product => this.renderProductCard(product)).join('')}
                    </div>
                `;
            },

            renderProductCard(product) {
                return `
                    <article class="product-card">
                        <header class="product-header">
                            <h3 class="product-title">${product.name}</h3>
                            <span class="product-category">${appState.getCategoryName(product.category)}</span>
                        </header>
                        <p class="product-description">${product.description}</p>
                        <footer class="product-footer">
                            <span class="product-price">‚Ç¨${product.price.toFixed(2)}</span>
                            <div class="product-actions">
                                <button onclick="ProductManager.editProduct(${product.id})" class="btn btn-primary">Modifica</button>
                                <button onclick="ProductManager.deleteProduct(${product.id})" class="btn btn-danger">Elimina</button>
                            </div>
                        </footer>
                    </article>
                `;
            },

            renderEmptyState() {
                return `
                    <div class="empty-state">
                        <h3>Nessun prodotto trovato</h3>
                        <p>Non ci sono prodotti ${appState.currentFilter ? 'in questa categoria' : 'nel database'}</p>
                        <button onclick="ProductManager.showProductForm()" class="btn btn-primary">Aggiungi Prodotto</button>
                    </div>
                `;
            }
        };

        // ==========================================
        // PRODUCT MANAGEMENT MODULE
        // ==========================================
        
        const ProductManager = {
            showProducts() {
                Utils.hideAllPanels();
                document.getElementById('productTable').classList.remove('hidden');
                UI.renderProducts();
            },

            filterProducts(categoryId) {
                appState.currentFilter = categoryId;
                this.showProducts();
            },

            showProductForm(productId = null) {
                Utils.hideAllPanels();
                document.getElementById('productForm').classList.remove('hidden');
                
                Utils.resetForm('#productForm form');
                
                if (productId) {
                    this.loadProductData(productId);
                } else {
                    document.getElementById('productId').value = '';
                }
            },

            loadProductData(productId) {
                const product = appState.products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('category').value = product.category;
                    document.getElementById('name').value = product.name;
                    document.getElementById('description').value = product.description;
                    document.getElementById('price').value = product.price;
                }
            },

            async editProduct(id) {
                try {
                    const product = appState.products.find(p => p.id === id);
                    if (product) {
                        this.showProductForm(product.id);
                    } else {
                        Utils.showNotification('Prodotto non trovato');
                    }
                } catch (error) {
                    Utils.showNotification('Errore nel caricamento del prodotto');
                    console.error('Errore editProduct:', error);
                }
            },

            async deleteProduct(id) {
                if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
                    try {
                        await menuDB.deleteProduct(id);
                        await appState.loadData();
                        this.showProducts();
                        Utils.showNotification('Prodotto eliminato');
                    } catch (error) {
                        Utils.showNotification('Errore nell\'eliminazione');
                        console.error('Errore deleteProduct:', error);
                    }
                }
            },

            async saveProduct(event) {
                event.preventDefault();
                
                try {
                    const productData = this.getProductFormData();
                    const productId = document.getElementById('productId').value;

                    if (productId) {
                        await menuDB.updateProduct(parseInt(productId), productData);
                        Utils.showNotification('Prodotto modificato');
                    } else {
                        const nextId = await menuDB.getNextProductId();
                        await menuDB.addProduct({ id: nextId, ...productData });
                        Utils.showNotification('Prodotto aggiunto');
                    }

                    await appState.loadData();
                    UI.renderCategories();
                    this.showProducts();
                } catch (error) {
                    Utils.showNotification('Errore nel salvataggio');
                    console.error('Errore saveProduct:', error);
                }
            },

            getProductFormData() {
                return {
                    category: document.getElementById('category').value,
                    name: document.getElementById('name').value,
                    description: document.getElementById('description').value,
                    price: parseFloat(document.getElementById('price').value)
                };
            }
        };

        // ==========================================
        // CATEGORY MANAGEMENT MODULE
        // ==========================================
        
        const CategoryManager = {
            showCategoryManagement() {
                Utils.hideAllPanels();
                document.getElementById('categoryManagement').classList.remove('hidden');
            },

            showCategoryForm(mode) {
                Utils.hideAllPanels();
                document.getElementById('categoryForm').classList.remove('hidden');
                
                this.configureCategoryForm(mode);
            },

            configureCategoryForm(mode) {
                const modeConfig = {
                    add: { title: 'Aggiungi Categoria', submitText: 'Aggiungi', showSelect: false, btnClass: 'btn-primary' },
                    edit: { title: 'Modifica Categoria', submitText: 'Modifica', showSelect: true, btnClass: 'btn-primary' },
                    delete: { title: 'Elimina Categoria', submitText: 'Elimina', showSelect: true, btnClass: 'btn-danger' }
                };

                const config = modeConfig[mode];
                document.getElementById('categoryMode').value = mode;
                document.getElementById('categoryFormTitle').textContent = config.title;
                document.getElementById('categorySubmitBtn').textContent = config.submitText;
                document.getElementById('categorySubmitBtn').className = `btn ${config.btnClass}`;
                document.getElementById('categorySelect').style.display = config.showSelect ? 'block' : 'none';

                Utils.resetForm('#categoryForm form');
                document.getElementById('categoryMode').value = mode;

                this.configureFormFields(mode);

                if (config.showSelect) {
                    this.populateCategorySelect();
                }
            },

            configureFormFields(mode) {
                const fields = ['categoryId', 'categoryName', 'categoryEmoji'];
                fields.forEach(field => {
                    document.getElementById(field).disabled = mode === 'delete';
                });
            },

            populateCategorySelect() {
                const select = document.getElementById('categoryToEdit');
                select.innerHTML = appState.categories.map(cat => 
                    `<option value="${cat.id}">${cat.emoji} ${cat.name}</option>`
                ).join('');
                
                if (appState.categories.length > 0) {
                    this.loadCategoryData();
                }
            },

            loadCategoryData() {
                const selectedId = document.getElementById('categoryToEdit').value;
                const category = appState.categories.find(c => c.id === selectedId);
                if (category) {
                    document.getElementById('originalCategoryId').value = category.id;
                    document.getElementById('categoryId').value = category.id;
                    document.getElementById('categoryName').value = category.name;
                    document.getElementById('categoryEmoji').value = category.emoji;
                }
            },

            async saveCategory(event) {
                event.preventDefault();
                
                const mode = document.getElementById('categoryMode').value;
                const categoryData = this.getCategoryFormData();

                try {
                    switch (mode) {
                        case 'add':
                            await this.addCategory(categoryData);
                            break;
                        case 'edit':
                            await this.editCategory(categoryData);
                            break;
                        case 'delete':
                            await this.deleteCategory();
                            break;
                    }

                    await appState.loadData();
                    UI.renderCategories();
                    this.showCategoryManagement();
                } catch (error) {
                    Utils.showNotification('Errore: ' + error.message);
                    console.error('Errore saveCategory:', error);
                }
            },

            getCategoryFormData() {
                return {
                    id: document.getElementById('categoryId').value.toLowerCase().replace(/\s+/g, '-'),
                    name: document.getElementById('categoryName').value,
                    emoji: document.getElementById('categoryEmoji').value
                };
            },

            async addCategory(categoryData) {
                if (appState.categories.find(c => c.id === categoryData.id)) {
                    throw new Error('ID categoria gi√† esistente');
                }
                await menuDB.addCategory(categoryData);
                Utils.showNotification('Categoria aggiunta');
            },

            async editCategory(categoryData) {
                const originalId = document.getElementById('originalCategoryId').value;
                
                if (categoryData.id !== originalId) {
                    if (appState.categories.find(c => c.id === categoryData.id)) {
                        throw new Error('ID categoria gi√† esistente');
                    }
                    
                    await menuDB.deleteCategory(originalId);
                    await menuDB.addCategory(categoryData);
                    
                    // Update products with new category ID
                    const productsToUpdate = appState.products.filter(p => p.category === originalId);
                    for (const product of productsToUpdate) {
                        await menuDB.updateProduct(product.id, { ...product, category: categoryData.id });
                    }
                } else {
                    await menuDB.addCategory(categoryData);
                }
                Utils.showNotification('Categoria modificata');
            },

            async deleteCategory() {
                const categoryId = document.getElementById('originalCategoryId').value;
                const productsInCategory = appState.products.filter(p => p.category === categoryId);
                
                if (productsInCategory.length > 0) {
                    const confirmDelete = confirm(
                        `Ci sono ${productsInCategory.length} prodotti in questa categoria. ` +
                        `Eliminarla canceller√† anche tutti i prodotti. Continuare?`
                    );
                    if (!confirmDelete) return;
                    
                    for (const product of productsInCategory) {
                        await menuDB.deleteProduct(product.id);
                    }
                }
                
                await menuDB.deleteCategory(categoryId);
                Utils.showNotification('Categoria eliminata');
            }
        };

        // ==========================================
        // QR CODE MANAGEMENT MODULE
        // ==========================================
        
        const QRCodeManager = {
            showQRCode() {
                Utils.hideAllPanels();
                document.getElementById('qrCodePanel').classList.remove('hidden');
                this.generateQRCode();
            },

            generateQRCode() {
                const container = document.getElementById('qrCodeContainer');
                container.innerHTML = '';

                const img = document.createElement('img');
                img.src = './img/QRMenu.png';
                img.alt = 'QR Code Menu BiblioCaf√®';
                img.className = 'qr-image';
                
                img.onerror = () => {
                    container.innerHTML = this.renderQRCodeError();
                    Utils.showNotification('Immagine QR Code non trovata');
                };

                container.appendChild(img);
            },

            renderQRCodeError() {
                return `
                    <div class="qr-error">
                        <div>üì±<br>Immagine QR Code<br>non trovata</div>
                    </div>
                `;
            },

            printQRCode() {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(this.generatePrintHTML());
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
                
                Utils.showNotification('QR Code inviato alla stampante');
            },

            generatePrintHTML() {
                return `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>QR Code Menu - BiblioCaf√®</title>
                        <style>
                            body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
                            .qr-container { border: 2px solid #0c4840; border-radius: 12px; padding: 2rem; margin: 2rem auto; max-width: 400px; }
                            h1 { color: #0c4840; margin-bottom: 1rem; }
                            .qr-image { max-width: 100%; height: auto; border-radius: 8px; }
                            .instructions { margin-top: 1.5rem; color: #666; font-size: 0.9rem; }
                        </style>
                    </head>
                    <body>
                        <div class="qr-container">
                            <h1>BiblioCaf√®</h1>
                            <h2>Menu Digitale</h2>
                            <img src="./img/QRMenu.png" alt="QR Code Menu" class="qr-image">
                            <div class="instructions">
                                Inquadra il QR Code con la fotocamera del tuo smartphone<br>
                                per accedere al menu digitale
                            </div>
                        </div>
                    </body>
                    </html>
                `;
            }
        };

        // ==========================================
        // MAIN APPLICATION MODULE
        // ==========================================
        
        const App = {
            async initialize() {
                try {
                    await menuDB.init();
                    await menuDB.seedDatabase();
                    await appState.loadData();
                    UI.renderCategories();
                    ProductManager.showProducts();
                } catch (error) {
                    console.error('Errore inizializzazione:', error);
                    Utils.showNotification('Errore nel caricamento dei dati');
                }
            }
        };

        // ==========================================
        // GLOBAL EVENT HANDLERS
        // ==========================================
        
        // Make functions globally accessible for onclick handlers
        window.handleLogin = Auth.handleLogin.bind(Auth);
        window.logout = Auth.logout.bind(Auth);
        window.showProducts = ProductManager.showProducts.bind(ProductManager);
        window.filterProducts = ProductManager.filterProducts.bind(ProductManager);
        window.showProductForm = ProductManager.showProductForm.bind(ProductManager);
        window.editProduct = ProductManager.editProduct.bind(ProductManager);
        window.deleteProduct = ProductManager.deleteProduct.bind(ProductManager);
        window.saveProduct = ProductManager.saveProduct.bind(ProductManager);
        window.showCategoryManagement = CategoryManager.showCategoryManagement.bind(CategoryManager);
        window.showCategoryForm = CategoryManager.showCategoryForm.bind(CategoryManager);
        window.loadCategoryData = CategoryManager.loadCategoryData.bind(CategoryManager);
        window.saveCategory = CategoryManager.saveCategory.bind(CategoryManager);
        window.showQRCode = QRCodeManager.showQRCode.bind(QRCodeManager);
        window.printQRCode = QRCodeManager.printQRCode.bind(QRCodeManager);

        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('BiblioCaf√® Admin Panel caricato');
        });
    </script>
</body>
</html>
